create or replace PROCEDURE               PHM_APA_IA_GROUP_ALGORITHM(V_ALG_NUM NUMBER,V_RUN_DATE DATE,V_BATCH_NUM VARCHAR2, V_UNIX_ID VARCHAR2)
IS

VALGNAME            VARCHAR(200);
V_PROCESS_TYPE      VARCHAR2(50);
V_RUN_MODE          VARCHAR2(20);
V_ROUTINE_NAME      VARCHAR(100);
V_PROD_FAMILY       VARCHAR2(50);
V_ROUTINE_TYPE      VARCHAR(50);
V_TH_ALG_NUM        NUMBER(19);
V_TH_PAT_SK         NUMBER(19);

V_PROCESS_ID        NUMBER(19);
V_PROCESS_STATUS    VARCHAR2(25):= 'STARTED';
V_FLAG              VARCHAR(5);
V_NUM_DAYS          NUMBER(2);
VIHN4_CALL_MESSAGE  VARCHAR(250);
V_ERROR_MESSAGE     VARCHAR(4000);

V_INSERT_COUNT NUMBER(10):= 0;
V_FLAG_DATE_TIME DATE;
V_RES_COUNT NUMBER;
V_SUM_COUNT NUMBER;
V_INSTR_COUNT NUMBER := 0;
V_TTL_ITRNS_CNT NUMBER := 0;
V_FLAGGED_COUNT NUMBER := 0;
V_LATEST_RECORD BOOLEAN := FALSE;

-- algorithm parameters
V_ERROR_CODE            VARCHAR2(50);
V_ERROR_COUNT           NUMBER(2);
V_IHN_LEVEL3_DESC       VARCHAR2(250);
V_THRESHOLD_DAYS        NUMBER(3);
V_THRESHOLD_DATA_DAYS   NUMBER(3);
V_ERROR_EXP             VARCHAR(4000);
V_THRESHOLD_TYPE        VARCHAR2(100);

V_FLAGGED_PL       VARCHAR2(10);
V_FLAGGED_EXP_CODE VARCHAR2(10);
V_IS_MANUAL_EXEC   VARCHAR2(1);


BEGIN

SELECT AR.ROUTINE_NAME, AR.ROUTINE_TYPE,AR.RUN_MODE,AR.ROUTINE_INVOKE_COMMAND,PF.PRODUCT_FAMILY_NAME
        INTO VALGNAME, V_PROCESS_TYPE, V_RUN_MODE, V_ROUTINE_NAME, V_PROD_FAMILY
  FROM PHM_ALGORITHM_ROUTINES AR,PHM_PATTERNS PP , PHM_PRODUCT_FAMILY PF 
  WHERE AR.PHM_PATTERNS_SK = V_ALG_NUM   AND PP.PHM_PATTERNS_SK = AR.PHM_PATTERNS_SK
        AND PP.PHM_PROD_FAMILY_SK = PF.PHM_PROD_FAMILY_SK  AND NVL(PP.DELETE_FLAG,'N') <> 'Y';
    
 select PHM_ALGORITHM_DEFINITIONS_SK, PHM_PATTERNS_SK
        INTO V_TH_ALG_NUM, V_TH_PAT_SK
        from phm_patterns where PHM_PATTERNS_SK=V_ALG_NUM;
  
V_PROCESS_ID := PHM_ALGORITHM_UTILITIES_1.PHM_GET_PROCESS_ID();
 
V_PROCESS_STATUS := 'STARTED';

PHM_ALGORITHM_UTILITIES_1.PHM_PROCESS_AUDIT_LOG(V_PROCESS_ID,V_PROD_FAMILY,V_PROCESS_TYPE,V_ROUTINE_TYPE,VALGNAME,V_ROUTINE_NAME,V_RUN_MODE
                ,V_PROCESS_STATUS,V_ERROR_MESSAGE,V_RUN_DATE ,SYSDATE,V_BATCH_NUM,V_UNIX_ID,V_ALG_NUM);

 FOR ALGS IN (SELECT pp.phm_patterns_sk FROM PHM_PATTERNS pp
    JOIN PHM_ALGORITHM_ROUTINES par 
        on pp.phm_patterns_sk=par.PHM_PATTERNS_SK
        where PHM_REUSABLE_ROUTINE_SK=(select PHM_ALGORITHM_ROUTINE_SK from PHM_ALGORITHM_ROUTINES where phm_patterns_sk=V_ALG_NUM)
        and par.ENABLE_YN='Y' AND par.DELETE_FLAG='N')  
    LOOP
       BEGIN
        PHM_APA_IA_ALGORITHM(ALGS.phm_patterns_sk,V_RUN_DATE,V_BATCH_NUM,V_UNIX_ID);
        -- CONTINUE in case of exceptions, errors will be logged by algorithm in phm_process_audit if any
        EXCEPTION
        WHEN OTHERS THEN
                CONTINUE;
        END;
    END LOOP;   

V_PROCESS_STATUS := 'COMPLETED';

        PHM_ALGORITHM_UTILITIES_1.PHM_PROCESS_AUDIT_LOG(V_PROCESS_ID,V_PROD_FAMILY,V_PROCESS_TYPE,V_ROUTINE_TYPE,VALGNAME,V_ROUTINE_NAME,V_RUN_MODE
                ,V_PROCESS_STATUS,V_ERROR_MESSAGE,V_RUN_DATE ,SYSDATE,V_BATCH_NUM,V_UNIX_ID,V_ALG_NUM);
                
EXCEPTION
    WHEN OTHERS THEN
       V_PROCESS_STATUS := 'ERRORED';
       V_ERROR_MESSAGE  := 'PHM_APA_IA_GROUP_ALGORITHM EXECUTION FAILED DUE TO ' || SQLERRM;
       PHM_ALGORITHM_UTILITIES_1.PHM_PROCESS_AUDIT_LOG(V_PROCESS_ID,V_PROD_FAMILY,V_PROCESS_TYPE,V_ROUTINE_TYPE,VALGNAME,V_ROUTINE_NAME
                ,V_RUN_MODE,V_PROCESS_STATUS,V_ERROR_MESSAGE,V_RUN_DATE,SYSDATE,V_BATCH_NUM,V_UNIX_ID,V_ALG_NUM);
       COMMIT;

END PHM_APA_IA_GROUP_ALGORITHM;