-- 
-- INSERT INTO dx.dx_architect_maint
-- (
--   architect_countrycode,
--   architect_customernumber,
--   architect_dateformat,
--   architect_deviceid,
--   architect_deviceserial,
--   architect_fileversion,
--   architect_modoptics,
--   architect_moduleid,
--   architect_moduleserial,
--   architect_moduletype,
--   architect_platform,
--   architect_productline,
--   architect_softwareversion,
--   blacklisted,
--   completiondate,
--   completiondate_iso,
--   date_,
--   derived_created_dt,
--   duplicate,
--   file_path,
--   frequency,
--   hash_,
--   hr_,
--   list_nbr,
--   list_sale_sz,
--   moduleid,
--   operator,
--   output_created_dt,
--   parse_path,
--   parsed_created_dt,
--   pkey,
--   PROCEDURE,
--   result,
--   tresataid__customer,
--   tresataid__customer_a,
--   version,
--   transaction_date
-- )
-- VALUES
-- (
--   'architect_countrycode_value',
--   'architect_customernumber_value',
--   'architect_dateformat_value',
--   'architect_deviceid_value',
--   'architect_deviceserial_value',
--   'architect_fileversion_value',
--   'architect_modoptics_value',
--   architect_moduleid_value,
--   'architect_moduleserial_value',
--   'architect_moduletype_value',
--   'architect_platform_value',
--   'architect_productline_value',
--   'architect_softwareversion_value',
--   'blacklisted_value',
--   'completiondate_value',
--   completiondate_iso_value,
--   date__value,
--   'derived_created_dt_value',
--   'duplicate_value',
--   'file_path_value',
--   'frequency_value',
--   'hash__value',
--   hr__value,
--   'list_nbr_value',
--   'list_sale_sz_value',
--   moduleid_value,
--   'operator_value',
--   'output_created_dt_value',
--   'parse_path_value',
--   'parsed_created_dt_value',
--   'pkey_value',
--   'procedure_value',
--   'result_value',
--   'tresataid__customer_value',
--   'tresataid__customer_a_value',
--   version_value,
--   'transaction_date_value'
-- );
-- 

-- INSERT INTO dx.dx_architect_results
-- (
--   architect_countrycode,
--   architect_customernumber,
--   architect_dateformat,
--   architect_deviceid,
--   architect_deviceserial,
--   architect_fileversion,
--   architect_modoptics,
--   architect_moduleid,
--   architect_moduleserial,
--   architect_moduletype,
--   architect_platform,
--   architect_productline,
--   architect_softwareversion,
--   assaycalibrationdate,
--   assaycalibrationtime,
--   assayid,
--   assaystatus,
--   avgbackground,
--   avgforeground,
--   blacklisted,
--   calculatedabsorbance,
--   calibrationdatetime,
--   calibrationdatetime_iso,
--   completiondatetime,
--   completiondatetime_iso,
--   constituentreplicateid1,
--   constituentreplicateid2,
--   constituentreplicateid3,
--   constituentreplicateid4,
--   correctedcount,
--   curveshape,
--   cuvettenumber,
--   darkcount,
--   darksubreads,
--   date_,
--   derived_created_dt,
--   dilutionid,
--   dilutionprotocol,
--   duplicate,
--   exceptioncode,
--   exceptionstring,
--   file_path,
--   hash_,
--   hr_,
--   initiationdatetime,
--   initiationdatetime_iso,
--   list_nbr,
--   list_sale_sz,
--   moduleid,
--   modulesnlog,
--   operator,
--   ordereddatetime,
--   ordereddatetime_iso,
--   output_created_dt,
--   parse_path,
--   parsed_created_dt,
--   patientid,
--   pkey,
--   postsamplereferenceread,
--   presamplereferenceread,
--   primarywavelength,
--   primarywavelengthreads,
--   reagentlot,
--   reagentsn,
--   replicateid,
--   reportedresult,
--   reportedresultunits,
--   reportedresultvalue,
--   result,
--   resultcomment,
--   resultdetails,
--   resultflags,
--   resultinterpretation,
--   sampledelta,
--   sampleid,
--   samplelot,
--   sampleread,
--   sampletype,
--   secondarywavelength,
--   secondarywavelengthreads,
--   signalcount,
--   signalsubreads,
--   stdbackground,
--   stdforeground,
--   testcompletiondate,
--   testcompletiontime,
--   testinitiationdate,
--   testinitiationtime,
--   testorderdate,
--   testordertime,
--   tresataid__customer,
--   tresataid__customer_a,
--   "1",
--   a,
--   dilu,
--   vgbak,
--   rusultdetails,
--   result_,
--   resultinterpreta,
--   dresult,
--   testcompleti,
--   corre,
--   "count",
--   ctedcount,
--   reportedr,
--   correcte,
--   tastinitiationdate,
--   testordertima,
--   "䀊",
--   repo,
--   resultdetaihs,
--   dilutionp,
--   "8",
--   res,
--   resu,
--   test,
--   repor,
--   testcolpletiondate,
--   testinitiationd,
--   dertime,
--   signal_,
--   ass,
--   "5",
--   ed,
--   reagenpmasterlot,
--   stdba,
--   testcompletiontate,
--   reportedresultun,
--   reagentmaster,
--   avg_,
--   transaction_date
-- )
-- VALUES
-- (
--   'architect_countrycode_value',
--   'architect_customernumber_value',
--   'architect_dateformat_value',
--   'architect_deviceid_value',
--   'architect_deviceserial_value',
--   'architect_fileversion_value',
--   'architect_modoptics_value',
--   architect_moduleid_value,
--   'architect_moduleserial_value',
--   'architect_moduletype_value',
--   'architect_platform_value',
--   'architect_productline_value',
--   'architect_softwareversion_value',
--   'assaycalibrationdate_value',
--   'assaycalibrationtime_value',
--   assayid_value,
--   'assaystatus_value',
--   avgbackground_value,
--   avgforeground_value,
--   'blacklisted_value',
--   calculatedabsorbance_value,
--   'calibrationdatetime_value',
--   calibrationdatetime_iso_value,
--   'completiondatetime_value',
--   completiondatetime_iso_value,
--   'constituentreplicateid1_value',
--   'constituentreplicateid2_value',
--   'constituentreplicateid3_value',
--   'constituentreplicateid4_value',
--   correctedcount_value,
--   curveshape_value,
--   cuvettenumber_value,
--   darkcount_value,
--   'darksubreads_value',
--   date__value,
--   'derived_created_dt_value',
--   dilutionid_value,
--   'dilutionprotocol_value',
--   'duplicate_value',
--   'exceptioncode_value',
--   'exceptionstring_value',
--   'file_path_value',
--   'hash__value',
--   hr__value,
--   'initiationdatetime_value',
--   initiationdatetime_iso_value,
--   'list_nbr_value',
--   'list_sale_sz_value',
--   moduleid_value,
--   'modulesnlog_value',
--   'operator_value',
--   'ordereddatetime_value',
--   ordereddatetime_iso_value,
--   'output_created_dt_value',
--   'parse_path_value',
--   'parsed_created_dt_value',
--   'patientid_value',
--   'pkey_value',
--   postsamplereferenceread_value,
--   presamplereferenceread_value,
--   primarywavelength_value,
--   'primarywavelengthreads_value',
--   'reagentlot_value',
--   reagentsn_value,
--   replicateid_value,
--   'reportedresult_value',
--   'reportedresultunits_value',
--   reportedresultvalue_value,
--   result_value,
--   'resultcomment_value',
--   'resultdetails_value',
--   'resultflags_value',
--   'resultinterpretation_value',
--   sampledelta_value,
--   'sampleid_value',
--   'samplelot_value',
--   sampleread_value,
--   'sampletype_value',
--   secondarywavelength_value,
--   'secondarywavelengthreads_value',
--   signalcount_value,
--   'signalsubreads_value',
--   stdbackground_value,
--   stdforeground_value,
--   'testcompletiondate_value',
--   'testcompletiontime_value',
--   'testinitiationdate_value',
--   'testinitiationtime_value',
--   'testorderdate_value',
--   'testordertime_value',
--   'tresataid__customer_value',
--   'tresataid__customer_a_value',
--   '1_value',
--   'a_value',
--   'dilu_value',
--   'vgbak_value',
--   'rusultdetails_value',
--   'result__value',
--   'resultinterpreta_value',
--   'dresult_value',
--   'testcompleti_value',
--   'corre_value',
--   'count_value',
--   'ctedcount_value',
--   'reportedr_value',
--   'correcte_value',
--   'tastinitiationdate_value',
--   'testordertima_value',
--   '䀊_value',
--   'repo_value',
--   'resultdetaihs_value',
--   'dilutionp_value',
--   '8_value',
--   'res_value',
--   'resu_value',
--   'test_value',
--   'repor_value',
--   'testcolpletiondate_value',
--   'testinitiationd_value',
--   'dertime_value',
--   'signal__value',
--   'ass_value',
--   '5_value',
--   'ed_value',
--   'reagenpmasterlot_value',
--   'stdba_value',
--   'testcompletiontate_value',
--   'reportedresultun_value',
--   'reagentmaster_value',
--   'avg__value',
--   'transaction_date_value'
-- );




--     CURSOR DEVICE_SN_LIST
--     IS
--     SELECT
--         IA.DEVICEID,
--         UPPER(IA.MODULESNDRM) SERIAL_NUM,
--         MAX (IL.PL) PL,
--         MAX (IL.CUSTOMER_NUM) CUSTOMER_NUMBER,
--         MAX (IL.CUSTOMER) CUSTOMER_NAME,
--         MAX (PC.COUNTRY) COUNTRY_NAME,
--         MAX (PC.AREAREGION) AREA,
--         MAX (IL.CITY) CITY,
--         MAX (COMPLETIONDATE) MAX_COMPLETION_DATE,
--         COUNT (*) DEVICE_SN_CNT
--     FROM 
--         SVC_PHM_ODS.PHM_ODS_RESULTS_IA IA,
--         INSTRUMENTLISTING IL,
--         PHM_COUNTRY PC
--     WHERE 
--         IA.BATCH_NUM = V_BATCH_NUM 
--     AND 
--         IA.RUN_DATE = V_RUN_DATE 
--     AND 
--         UPPER (IA.MODULESNDRM) = UPPER (IL.SN) 
--     AND
--         PC.COUNTRY_CODE = IL.COUNTRY_CODE
--     GROUP BY 
--         IA.DEVICEID, 
--         IA.MODULESNDRM

--     SELECT 
--         * BULK COLLECT INTO FLG_TBL 
--     FROM (
--         SELECT
--             FINALDAT.DEVICEID,
--             FINALDAT.MODULESNDRM,
--             FINALDAT.RESULT_TR,
--             FINALDAT.MINDATE AS FIRST_FAIL,
--             FINALDAT.MAXDATE AS LAST_FAIL,
--             FINALDAT.CNT AS N_FAIL,
--             FINALDAT.N_DAYS_WITH_FAIL,
--             TRUNC(SYSDATE,'DDD') - TRUNC(FINALDAT.MINDATE,'DDD') AS N_DAYS_SINCE_FIRST_FAIL
--         FROM (
--             SELECT
--                 DAT.DEVICEID,
--                 DAT.MODULESNDRM,
--                 DAT.RESULT_TR,
--                 DAT.MINDATE,
--                 DAT.MAXDATE,
--                 DAT.CNT,
--                 DAT.N_DAYS_WITH_FAIL,
--                 ROW_NUMBER() OVER (PARTITION BY DAT.MODULESNDRM ORDER BY DAT.MAXDATE DESC) AS RN
--             FROM (
--                 SELECT
--                     RESULTS.DEVICEID,
--                     RESULTS.MODULESNDRM,
--                     RESULTS.RESULT_TR,
--                     MIN(RESULTS.COMPLETIONDATE) AS MINDATE,
--                     MAX(RESULTS.COMPLETIONDATE) AS MAXDATE,
--                     COUNT(DISTINCT(TRUNC(RESULTS.COMPLETIONDATE,'DDD'))) AS N_DAYS_WITH_FAIL,
--                     COUNT(*) AS CNT
--                 FROM (
--                     SELECT
--                         M.*,
--                         ROW_NUMBER() OVER (ORDER BY M.MODULESNDRM,M.COMPLETIONDATE DESC) AS A,
--                         ROW_NUMBER() OVER (PARTITION BY M.RESULT_TR ORDER BY M.MODULESNDRM,M.COMPLETIONDATE DESC) AS B,
--                         (ROW_NUMBER() OVER (ORDER BY M.MODULESNDRM,M.COMPLETIONDATE DESC) - 
--                         ROW_NUMBER() OVER (PARTITION BY M.RESULT_TR ORDER BY M.MODULESNDRM,M.COMPLETIONDATE DESC)) AS DI
--                     FROM (
--                         SELECT 
--                             *
--                         FROM
--                             SVC_PHM_ODS.PHM_ODS_DM_FAIL_IA MA
--                         ORDER BY 
--                             MA.MODULESNDRM,
--                             MA.COMPLETIONDATE DESC
--                     ) M
--                     ORDER BY 
--                         M.MODULESNDRM,
--                         M.COMPLETIONDATE DESC
--                 ) RESULTS
--                 GROUP BY
--                     RESULTS.DEVICEID,
--                     RESULTS.MODULESNDRM,
--                     RESULTS.RESULT_TR,
--                     RESULTS.DI
--                 ORDER BY 
--                     RESULTS.MODULESNDRM
--             ) DAT
--         ) FINALDAT
--         WHERE 
--             FINALDAT.RN = 1 
--         AND 
--             FINALDAT.RESULT_TR = 'Failed' 
--         AND 
--             FINALDAT.N_DAYS_WITH_FAIL > 1

with maintenance_cte as (
select 
    ma.architect_deviceid,
    ma.architect_moduleid,
    upper(trim(ma.architect_moduleserial)) as architect_moduleserial,
    ma.architect_productline,
    ma.completiondate_iso,
    ma.result,
    case when (ma.result like 'Completed' or 
               ma.result like 'Completata' or
               ma.result like 'Finalizado' or
               ma.result like 'Terminé' or
               ma.result like 'Abgeschlossen' or
               ma.result like 'Concluído' or
               ma.result like 'Dokonceno' or
               ma.result like '??????' or
               ma.result like '??' or 
               ma.result like '???') 
         then 'complete' 
         when (ma.result like 'Failed' or
               ma.result like '??' or
               ma.result like '???' or
               ma.result like 'Fallita' or
               ma.result like 'Fallido' or
               ma.result like 'Echoué' or
               ma.result like 'Fehlgeschlagen' or
               ma.result like 'Falhado' or
               ma.result like 'Chyba' or
               ma.result like '??????')
         then 'failed'
         when (ma.result like 'User canceled' or
               ma.result like '????' or
               ma.result like '???????????' or
               ma.result like 'Annullata' or
               ma.result like 'Cancel usuario' or
               ma.result like 'Cancelado utili.' or
               ma.result like 'Annulé par utilis.' or
               ma.result like 'Benutzerabbruch' or
               ma.result like 'Zru' or
               ma.result like 'Zrueno uivatelem' or
               ma.result like '??????')
         then 'failed'
         else null 
         end as result_tr
from
    dx.dx_architect_maint ma
where
    ma."PROCEDURE" like '%6041%' 
and
    ma.transaction_date >= '2019-09-13'
and
    ma.transaction_date < '2019-11-13'
order by 
    ma.architect_moduleserial,
    ma.completiondate_iso desc
),
flag_table_cte as (
select
    finaldat.architect_deviceid,
    finaldat.architect_moduleserial,
    finaldat.result_tr,
    finaldat.mindate as first_fail,
    finaldat.maxdate as last_fail,
    finaldat.cnt as n_fail,
    finaldat.n_days_with_fail,
    date_diff('day', 
              date_trunc('day', finaldat.mindate),
              date_trunc('day', date_parse('2019-11-13', '%Y-%m-%d'))) as n_days_since_first_fail
from (
    select
        dat.architect_deviceid,
        dat.architect_moduleserial,
        dat.result_tr,
        dat.mindate,
        dat.maxdate,
        dat.cnt,
        dat.n_days_with_fail,
        row_number() over (
            partition by 
                dat.architect_moduleserial 
            order by 
                dat.maxdate desc) as rn
    from (
        select
            results.architect_deviceid,
            results.architect_moduleserial,
            results.result_tr,
            min(results.completiondate_iso) as mindate,
            max(results.completiondate_iso) as maxdate,
            count(distinct(date_trunc('day', results.completiondate_iso))) as n_days_with_fail,
            count(*) as cnt
        from (
            select
                m.*,
                row_number() over (
                    order by 
                        m.architect_moduleserial,
                        m.completiondate_iso desc
                ) as a,
                row_number() over (
                    partition by 
                        m.result_tr 
                    order by 
                        m.architect_moduleserial,
                        m.completiondate_iso desc
                ) as b,
                ( row_number() over (
                      order by 
                          m.architect_moduleserial,
                          m.completiondate_iso desc) - 
                  row_number() over (
                      partition by 
                          m.result_tr 
                      order by 
                          m.architect_moduleserial,
                          m.completiondate_iso desc) ) as di
            from (
                select 
                    *
                from
                    maintenance_cte ma
                order by 
                    ma.architect_moduleserial,
                    ma.completiondate_iso desc
            ) m
            order by 
                m.architect_moduleserial,
                m.completiondate_iso desc
        ) results
        group by
            results.architect_deviceid,
            results.architect_moduleserial,
            results.result_tr,
            results.di
        order by 
            results.architect_moduleserial
    ) dat
) finaldat
where 
    finaldat.rn = 1 
and 
    finaldat.result_tr = 'failed' 
and 
    finaldat.n_days_with_fail > 1
),
flagged_cte as (
select
    data.architect_moduleserial,
    data.architect_productline,
    data.flag_date,
    data.v_n_patient_since_fail,
    data.v_n_days_with_patient,
    data.v_n_days_since_last_pat,
    case when (data.v_n_patient_since_fail >= 1) and
              (data.v_n_days_with_patient >= 1) and
              (data.v_n_days_since_last_pat <= 7)
         then 'YES'
         else 'NO' end as flagged
from (
    select
        dar.architect_moduleserial,
        dar.architect_productline,
        max(dar.completiondatetime_iso) as flag_date,
        count(*) as v_n_patient_since_fail,
        count(distinct(date_trunc('day', dar.completiondatetime_iso))) as v_n_days_with_patient,
        date_diff('day', 
                  date_trunc('day', max(dar.completiondatetime_iso)),
                  date_trunc('day', date_parse('2019-11-13', '%Y-%m-%d'))) as v_n_days_since_last_pat
    from
        dx.dx_architect_results dar
    inner join
        flag_table_cte ft
    on
        ft.architect_moduleserial = upper(trim(dar.architect_moduleserial))
    where
        dar.sampletype = 'PATIENT' 
    and
        dar.completiondatetime_iso >= ft.first_fail
    and
        dar.transaction_date >= '2019-09-13'
    and
        dar.transaction_date < '2019-11-13'
    group by
        dar.architect_moduleserial,
        dar.architect_productline
    ) data
)
select
    f.architect_moduleserial as modulesn,
    f.architect_productline as pl,
    date_format(f.flag_date,'%Y%m%d%H%i%s') as flag_date,
    f.v_n_patient_since_fail,
    f.v_n_days_with_patient,
    f.v_n_days_since_last_pat,
    f.flagged
from 
    flagged_cte f
where
    flagged = 'YES'
