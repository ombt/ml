
WITH APS_DEVICES_DATES_CTE AS (
SELECT  
    SN, 
    MIN(TRUNC(TIMESTAMP)) DT, 
    MAX(TIMESTAMP) DT_MAX
FROM 
    SVC_PHM_ODS.PHM_ODS_APS_ERRORS
WHERE 
    -- RUN_DATE = V_RUN_DATE 
    RUN_DATE = TO_DATE('05-NOV-2019')
AND 
    -- BATCH_NUM = V_BATCH_NUM  
    BATCH_NUM = 'BTH0600'
AND 
    -- TRUNC(TIMESTAMP) <> TRUNC(SYSDATE) 
    TRUNC(TIMESTAMP) <> TRUNC(TO_DATE('05-NOV-2019'))
GROUP BY 
    SN 
ORDER BY 1,2
),
PHM_APS_COUNTERS_TEMP_CTE AS (
SELECT 
    AC.DEVICE_ID,
    TRUNC(AC.TIMESTAMP) AS TIMESTAMP, 
    AC.SN, 
    AC.DURATION, 
    AC.DESCRIPTION, 
    AC.ID, 
    MAX(AC.VALUE) AS MAX_VALUE, 
    MIN(AC.VALUE) AS MIN_VALUE,
    COUNT(*) AS REC_COUNT
FROM 
    APS_COUNTERS AC
INNER JOIN
    APS_DEVICES_DATES_CTE DD
ON 
    DD.SN = AC.SN 
WHERE
    TRUNC(AC.TIMESTAMP) BETWEEN 
        DD.DT 
    AND 
        DD.DT_MAX + 1 -- TRUNC(TIMESTAMP) BETWEEN X.DT AND X.DT_MAX
AND 
    AC.ID IN ('normal','priority','tubes',
           '1','2','3','4','5','6','7','8')  
AND 
    AC.DURATION IN ('YTD')
AND 
    AC.DESCRIPTION IN ('InputTubeCounter','CentrifugeCounter','InstrumentBufferCounter')
GROUP BY 
    AC.DEVICE_ID, 
    TRUNC(AC.TIMESTAMP), 
    AC.SN, 
    AC.DURATION, 
    AC.DESCRIPTION, 
    AC.ID
),
APS_ERRORS_BCR23_CTE AS (
SELECT 
    AE.DEVICE_ID, 
    MAX(PSM.IOM_SN) AS IOM_SN, 
    PSM.PL, 
    PSM.SN, 
    TRUNC(AE.TIMESTAMP) AS DT, 
    COUNT(*) AS PAT_ERRCOUNT, 
    MAX(AE.TIMESTAMP) AS FLG_DATE
FROM 
    SVC_PHM_ODS.PHM_ODS_APS_ERRORS AE
INNER JOIN
    SVC_GSR_OWNER.APS_MESSAGES_PL_SN_MAP PSM 
ON
    PSM.IOM_SN = AE.SN
AND 
    PSM.MESSAGE LIKE '%' || 'Unreadable Sample ID (BCR 2)' || '%' 
INNER JOIN
    APS_DEVICES_DATES_CTE DD
ON 
    DD.SN = AE.SN
WHERE 
    AE.MESSAGE LIKE '%' || 'Unreadable Sample ID (BCR 2)' || '%' 
AND 
    AE.TIMESTAMP BETWEEN 
        -- VSTARTDATE 
        (DD.DT - 2)
    AND 
        -- VENDDATE
        DD.DT_MAX
GROUP BY 
    AE.DEVICE_ID, 
    PSM.PL, 
    PSM.SN, 
    TRUNC(AE.TIMESTAMP)
ORDER BY 
    PSM.PL, 
    PSM.SN, 
    TRUNC(AE.TIMESTAMP)
),
VCOUNT_1_MIN_CTE AS (
SELECT
    ACT.SN,
    ACT.TIMESTAMP,
    ACT.MAX_VALUE AS VCOUNT_1_MIN 
FROM
    APS_ERRORS_BCR23_CTE AE
INNER JOIN
    PHM_APS_COUNTERS_TEMP_CTE ACT
ON
    ACT.ID = 'tubes' 
AND 
    ACT.DURATION = 'YTD' 
AND 
    ACT.DESCRIPTION = 'CentrifugeCounter' 
AND 
    ACT.SN = AE.IOM_SN 
AND 
    ACT.TIMESTAMP <= AE.DT 
ORDER BY 
    ACT.SN,
    ACT.TIMESTAMP DESC
),
VCOUNT_1_MAX_CTE AS (
SELECT
    ACT.SN,
    ACT.TIMESTAMP,
    ACT.MAX_VALUE AS VCOUNT_1_MAX
FROM
    APS_ERRORS_BCR23_CTE AE
INNER JOIN
    PHM_APS_COUNTERS_TEMP_CTE ACT
ON
    ACT.ID = 'tubes' 
AND 
    ACT.DURATION = 'YTD' 
AND 
    ACT.DESCRIPTION = 'CentrifugeCounter' 
AND 
    ACT.SN = AE.IOM_SN 
AND 
    ACT.TIMESTAMP = AE.DT + 1
ORDER BY 
    ACT.SN,
    ACT.TIMESTAMP DESC
),
VCOUNT_1_MIN_MAX_CTE AS (
SELECT 
    VMIN.SN AS VMIN_SN,
    VMIN.TIMESTAMP as VMIN_TIMESTAMP,
    VMIN.VCOUNT_1_MIN,
    VMAX.SN AS VMAX_SN,
    VMAX.TIMESTAMP as VMAX_TIMESTAMP,
    VMAX.VCOUNT_1_MAX
FROM 
    VCOUNT_1_MIN_CTE VMIN
INNER JOIN
    VCOUNT_1_MAX_CTE VMAX
ON
    VMAX.SN = VMIN.SN
AND
    ( VMIN.TIMESTAMP + 1 ) = VMAX.TIMESTAMP
)
SELECT * FROM VCOUNT_1_MIN_MAX_CTE ORDER BY VMIN_SN ASC
